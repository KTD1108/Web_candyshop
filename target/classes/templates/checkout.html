<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Thanh toán</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-light">

<!-- Voucher Modal -->
<div class="modal fade" id="voucherModal" tabindex="-1" aria-labelledby="voucherModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="voucherModalLabel">Chọn mã giảm giá</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="voucher-list-container">
        <!-- Vouchers will be loaded here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="button" class="btn btn-primary" onclick="applySelectedVoucher()">Xác nhận</button>
      </div>
    </div>
  </div>
</div>

<div id="toast-container" class="toast-container"></div>

<nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/"><img src="/images/logo.jpg" alt="Tiệm ngọt 108 Logo" style="height: 70px;"></a>
    <div id="nav-auth" class="ms-auto d-flex align-items-center">
      <!-- Auth state will be rendered here by JavaScript -->
    </div>
  </div>
</nav>

<div class="container py-5">
  <div class="row g-5">
    <!-- Left Column: Forms -->
    <div class="col-md-7 col-lg-8">
      <h2 class="mb-4 section-title">Thông tin thanh toán</h2>
      <form id="checkout-form" novalidate>
        <!-- Shipping Info -->
        <h4 class="mb-3">1. Thông tin giao hàng</h4>
        <div class="row g-3">
          <div class="col-12">
            <label for="customerName" class="form-label">Họ và tên</label>
            <input type="text" class="form-control" id="customerName" placeholder="Tên người nhận" required>
            <div class="invalid-feedback">Vui lòng nhập họ tên người nhận.</div>
          </div>
          <div class="my-3">
            <div class="form-check">
              <input id="useProfile" name="addressOption" type="radio" class="form-check-input" checked required onchange="toggleAddressForm(true)">
              <label class="form-check-label" for="useProfile">Sử dụng địa chỉ mặc định</label>
            </div>
            <div class="form-check">
              <input id="useNew" name="addressOption" type="radio" class="form-check-input" required onchange="toggleAddressForm(false)">
              <label class="form-check-label" for="useNew">Sử dụng địa chỉ khác</label>
            </div>
          </div>
          <div id="profile-address-display" class="col-12">
            <div class="alert alert-secondary">
              <strong id="profile-address-text">Đang tải...</strong><br>
              <span id="profile-phone-text"></span>
            </div>
          </div>
          <div id="new-address-form" class="row g-3" style="display: none;">
            <div class="col-12">
              <label for="customerPhone" class="form-label">Số điện thoại</label>
              <input type="tel" class="form-control" id="customerPhone" placeholder="">
              <div class="invalid-feedback">Vui lòng nhập số điện thoại.</div>
            </div>
            <div class="col-12">
              <label for="address" class="form-label">Địa chỉ</label>
              <input type="text" class="form-control" id="address" placeholder="123 Nguyễn Huệ, Q.1, TP.HCM">
              <div class="invalid-feedback">Vui lòng nhập địa chỉ giao hàng.</div>
            </div>
          </div>
        </div>
        <hr class="my-4">

        <!-- Shipping Method -->
        <h4 class="mb-3">2. Phương thức vận chuyển</h4>
        <div class="d-block my-3">
          <div class="form-check">
            <input id="shippingStandard" name="shippingMethod" type="radio" class="form-check-input" value="STANDARD" checked required>
            <label class="form-check-label" for="shippingStandard">Giao hàng tiêu chuẩn (20.000 đ)</label>
          </div>
          <div class="form-check">
            <input id="shippingExpress" name="shippingMethod" type="radio" class="form-check-input" value="EXPRESS" required>
            <label class="form-check-label" for="shippingExpress">Giao hàng nhanh (40.000 đ)</label>
          </div>
        </div>
        <hr class="my-4">

        <!-- Payment Method -->
        <h4 class="mb-3">3. Phương thức thanh toán</h4>
        <div class="d-block my-3">
          <div class="form-check">
            <input id="paymentCod" name="paymentMethod" type="radio" class="form-check-input" value="COD" checked required>
            <label class="form-check-label" for="paymentCod">Thanh toán khi nhận hàng (COD)</label>
          </div>
          <div class="form-check">
            <input id="paymentBank" name="paymentMethod" type="radio" class="form-check-input" value="BANK_TRANSFER" required>
            <label class="form-check-label" for="paymentBank">Chuyển khoản ngân hàng</label>
          </div>
        </div>
        <div id="bank-info" class="alert alert-info" style="display: none;">
          <strong>Thông tin chuyển khoản:</strong><br>
          Ngân hàng: Vietcombank<br>
          Số tài khoản: 1039221077<br>
          Chủ tài khoản: Kiều Tiến Đạt<br>
          Nội dung: Thanh toan don hang (Mã đơn hàng sẽ được tạo sau khi đặt)
        </div>
        <hr class="my-4">

        <!-- Order Notes -->
        <h4 class="mb-3">4. Ghi chú</h4>
        <div class="col-12">
            <textarea class="form-control" id="orderNotes" rows="3" placeholder="Ghi chú thêm cho người bán..."></textarea>
        </div>
        <hr class="my-4">
        
        <button class="w-100 btn btn-primary btn-lg" type="submit">Hoàn tất đặt hàng</button>
      </form>
    </div>

  
    <div class="col-md-5 col-lg-4 order-md-last">
        <div class="card sticky-top" style="top: 100px;">
            <div class="card-header">
                <h4 class="d-flex justify-content-between align-items-center mb-0">
                    <span class="text-primary">Tóm tắt đơn hàng</span>
                    <span class="badge bg-primary rounded-pill" id="item-count">0</span>
                </h4>
            </div>
            <ul class="list-group list-group-flush" id="cart-summary-items">
                <!-- Cart items will be loaded here -->
            </ul>
            
            <div class="card-body">
                <button class="btn btn-outline-secondary w-100" type="button" onclick="openVoucherModal()">
                    Chọn hoặc nhập mã giảm giá
                </button>
            </div>

            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                    <span>Tạm tính (VND)</span>
                    <strong id="subtotal-price">0 đ</strong>
                </li>
                 <li class="list-group-item d-flex justify-content-between text-success">
                    <div>
                        <span>Giảm giá</span>
                        <small id="applied-voucher-code" class="d-block text-muted"></small>
                    </div>
                    <strong id="discount-price">-0 đ</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Phí vận chuyển</span>
                    <strong id="shipping-fee-price">0 đ</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between bg-light">
                    <h5 class="fw-bold mb-0">Tổng cộng</h5>
                    <h5 class="fw-bold mb-0" id="total-price">0 đ</h5>
                </li>
            </ul>
        </div>
    </div>
  </div>
</div>

<footer class="footer">
    <div class="container">
        <p class="text-center text-muted">&copy; 2025 </p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const token = localStorage.getItem('accessToken');
let userProfile = {};
let subtotal = 0;
const shippingFees = { STANDARD: 20000, EXPRESS: 40000 };
let availableVouchers = [];
let appliedVoucherCode = null;
let appliedDiscountAmount = 0;
let voucherModal;

document.addEventListener('DOMContentLoaded', () => {
    voucherModal = new bootstrap.Modal(document.getElementById('voucherModal'));
    loadCheckoutData();
    document.getElementById('checkout-form').addEventListener('submit', handleCheckout);
    document.querySelectorAll('input[name="shippingMethod"]').forEach(el => el.addEventListener('change', updateOrderSummary));
    document.querySelectorAll('input[name="paymentMethod"]').forEach(el => {
        el.addEventListener('change', (e) => {
            document.getElementById('bank-info').style.display = (e.target.value === 'BANK_TRANSFER') ? 'block' : 'none';
        });
    });
});


function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerText = message;
    container.appendChild(toast);
    setTimeout(() => { toast.classList.add('show'); }, 100);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}

function checkLogin() {
  if (!token) {
    showToast('Vui lòng đăng nhập để thanh toán.', 'error');
    setTimeout(() => { window.location = '/login'; }, 1500);
    return false;
  }
  return true;
}

function toggleAddressForm(useProfile) {
  const newAddressForm = document.getElementById('new-address-form');
  const profileAddressDisplay = document.getElementById('profile-address-display');
  const phoneInput = document.getElementById('customerPhone');
  const addressInput = document.getElementById('address');

  if (useProfile && !document.getElementById('useProfile').disabled) {
    newAddressForm.style.display = 'none';
    profileAddressDisplay.style.display = 'block';
    phoneInput.required = false;
    addressInput.required = false;
  } else {
    newAddressForm.style.display = 'flex';
    profileAddressDisplay.style.display = 'none';
    phoneInput.required = true;
    addressInput.required = true;
  }
}

function updateOrderSummary() {
    const selectedShipping = document.querySelector('input[name="shippingMethod"]:checked').value;
    const shippingFee = shippingFees[selectedShipping];
    const grandTotal = subtotal + shippingFee - appliedDiscountAmount;

    document.getElementById('shipping-fee-price').innerText = shippingFee.toLocaleString() + ' đ';
    document.getElementById('discount-price').innerText = '-' + appliedDiscountAmount.toLocaleString() + ' đ';
    document.getElementById('applied-voucher-code').innerText = appliedVoucherCode ? `Mã: ${appliedVoucherCode}` : '';
    document.getElementById('total-price').innerText = (grandTotal > 0 ? grandTotal : 0).toLocaleString() + ' đ';
}

function openVoucherModal() {
    const container = document.getElementById('voucher-list-container');
    container.innerHTML = ''; // Clear previous list
    if (availableVouchers.length > 0) {
        availableVouchers.forEach(v => {
            let description = `Giảm ${v.discountValue.toLocaleString()}`;
            if (v.discountType === 'PERCENTAGE') {
                description += '%';
                if(v.maxDiscountAmount) {
                    description += ` (tối đa ${v.maxDiscountAmount.toLocaleString()} đ)`;
                }
            } else {
                 description += ' đ';
            }
            description += ` cho đơn từ ${v.minOrderAmount.toLocaleString()} đ`;

            const isChecked = v.code === appliedVoucherCode ? 'checked' : '';

            container.innerHTML += `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="voucherOption" id="voucher-${v.id}" value="${v.code}" ${isChecked}>
                    <label class="form-check-label" for="voucher-${v.id}">
                        <strong>${v.code}</strong>: ${description}
                    </label>
                </div>
            `;
        });
    } else {
        container.innerHTML = '<p class="text-muted">Không có mã giảm giá nào phù hợp cho đơn hàng của bạn.</p>';
    }
     container.innerHTML += `
        <div class="form-check mt-3">
             <input class="form-check-input" type="radio" name="voucherOption" id="voucher-none" value="" ${!appliedVoucherCode ? 'checked' : ''}>
             <label class="form-check-label" for="voucher-none">Không sử dụng mã</label>
        </div>
     `;
    voucherModal.show();
}

function applySelectedVoucher() {
    const selectedOption = document.querySelector('input[name="voucherOption"]:checked');
    
    // Reset first
    appliedVoucherCode = null;
    appliedDiscountAmount = 0;

    if (selectedOption && selectedOption.value) { 
        const selectedCode = selectedOption.value;
        const selectedVoucher = availableVouchers.find(v => v.code === selectedCode);
        
        appliedVoucherCode = selectedVoucher.code;
        if (selectedVoucher.discountType === 'PERCENTAGE') {
            let discount = subtotal * (selectedVoucher.discountValue / 100);
            if(selectedVoucher.maxDiscountAmount && discount > selectedVoucher.maxDiscountAmount) {
                discount = selectedVoucher.maxDiscountAmount;
            }
            appliedDiscountAmount = discount;
        } else { // FIXED_AMOUNT
            appliedDiscountAmount = selectedVoucher.discountValue;
        }
        showToast('Đã áp dụng mã giảm giá!', 'success');
    } else {
        showToast('Đã bỏ chọn mã giảm giá.', 'info');
    }
    
    updateOrderSummary();
    voucherModal.hide();
}


async function loadCheckoutData() {
    if (!checkLogin()) return;
    await updateNavbar();

    const [userRes, cartRes] = await Promise.all([
        fetch('http://localhost:8080/api/user/profile', { headers: { 'Authorization': 'Bearer ' + token } }),
        fetch('http://localhost:8080/api/cart', { headers: { 'Authorization': 'Bearer ' + token } })
    ]);

    if (!userRes.ok || !cartRes.ok) {
        showToast('Phiên đăng nhập hết hạn.', 'error');
        setTimeout(() => { window.location = '/login'; }, 1500);
        return;
    }

    userProfile = await userRes.json();
    const cart = await cartRes.json();

    document.getElementById('customerName').value = userProfile.fullName || '';
    
    const profileAddrEl = document.getElementById('profile-address-text');
    const profilePhoneEl = document.getElementById('profile-phone-text');
    if (userProfile.address && userProfile.phone) {
        profileAddrEl.textContent = userProfile.address;
        profilePhoneEl.textContent = `SĐT: ${userProfile.phone}`;
    } else {
        profileAddrEl.innerHTML = 'Chưa có địa chỉ mặc định. <a href="/profile.html">Cập nhật hồ sơ</a>';
        profilePhoneEl.textContent = '';
        document.getElementById('useNew').checked = true;
        document.getElementById('useProfile').disabled = true;
    }

    const cartItemsContainer = document.getElementById('cart-summary-items');
    const subtotalEl = document.getElementById('subtotal-price');
    const itemCountEl = document.getElementById('item-count');
    cartItemsContainer.innerHTML = '';
    subtotal = 0;

    if (cart.cartItems && cart.cartItems.length > 0) {
        itemCountEl.innerText = cart.cartItems.length;
        cart.cartItems.forEach(item => {
            const itemTotal = item.product.price * item.quantity;
            subtotal += itemTotal;
            cartItemsContainer.innerHTML += `
                <li class="list-group-item d-flex justify-content-between lh-sm">
                    <div>
                        <h6 class="my-0">${item.product.name} (x${item.quantity})</h6>
                    </div>
                    <span class="text-muted">${itemTotal.toLocaleString()} đ</span>
                </li>
            `;
        });
    } else {
        window.location.href = '/cart.html';
    }

    subtotalEl.innerText = subtotal.toLocaleString() + ' đ';

   
    try {
        const voucherRes = await fetch(`/api/vouchers/available?subtotal=${subtotal}`);
        if(voucherRes.ok) {
            availableVouchers = await voucherRes.json();
        }
    } catch(e) { console.error("Could not fetch vouchers", e); }


    toggleAddressForm(document.getElementById('useProfile').checked);
    updateOrderSummary();
}

async function handleCheckout(event) {
    event.preventDefault();
    const form = event.target;
    
    form.classList.remove('was-validated');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }

    const checkoutData = {
        useProfileAddress: document.getElementById('useProfile').checked,
        customerName: document.getElementById('customerName').value,
        customerPhone: document.getElementById('customerPhone').value,
        address: document.getElementById('address').value,
        shippingMethod: document.querySelector('input[name="shippingMethod"]:checked').value,
        paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
        orderNotes: document.getElementById('orderNotes').value,
        voucherCode: appliedVoucherCode
    };

    try {
      const res = await fetch('http://localhost:8080/api/orders', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify(checkoutData)
      });
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.message || 'Lỗi khi đặt hàng.');
      }
      showToast('Đặt hàng thành công!', 'success');
      setTimeout(() => { window.location.href = '/orders.html'; }, 2000);
    } catch (error) {
       showToast(error.message, 'error');
    }
}

function logout() {
    localStorage.removeItem('accessToken');
    window.location.href = '/';
}

async function updateNavbar() {
    const token = localStorage.getItem('accessToken');
    const navAuthContainer = document.getElementById('nav-auth');
    if (!token) {
        navAuthContainer.innerHTML = `
            <a class="btn btn-outline-secondary btn-sm me-2" href="/about">Giới thiệu</a>
            <a class="btn btn-outline-secondary btn-sm" href="/login">Đăng nhập</a>
        `;
        return;
    }

    let cartItemCount = 0;
    try {
        const res = await fetch('http://localhost:8080/api/cart', { headers: { 'Authorization': 'Bearer ' + token } });
        if (res.ok) cartItemCount = (await res.json()).cartItems.length;
    } catch (e) { console.error(e); }

    let authHtml = `
        <a class="btn btn-outline-primary btn-sm me-2" href="/cart.html">
            Giỏ hàng <span class="badge bg-danger ms-1">${cartItemCount}</span>
        </a>
        <a class="btn btn-info btn-sm me-2" href="/orders.html">Đơn hàng</a>
        <a class="btn btn-success btn-sm me-2" href="/profile.html">Tài khoản</a>
        <a class="btn btn-outline-secondary btn-sm me-2" href="/about">Giới thiệu</a>
        <button class="btn btn-outline-secondary btn-sm" onclick="logout()">Đăng xuất</button>
    `;
    navAuthContainer.innerHTML = authHtml;
}

</script>
</body>
</html>