<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Thanh toán - CandyShop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-light">
<div id="toast-container" class="toast-container"></div>

<nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/"><img src="/images/logo.jpg" alt="CandyShop Logo" style="height: 70px;"></a>
    <div id="nav-auth" class="ms-auto d-flex align-items-center">
      <!-- Auth state will be rendered here by JavaScript -->
    </div>
  </div>
</nav>

<div class="container py-5">
  <h2 class="text-center mb-5 section-title">Thông tin thanh toán</h2>
  <div class="row g-5">
    <div class="col-md-7">
      <h4 class="mb-3">Thông tin giao hàng</h4>
      <form id="checkout-form" novalidate>
        <div class="row g-3">
          <div class="col-12">
            <label for="customerName" class="form-label">Họ và tên</label>
            <input type="text" class="form-control" id="customerName" placeholder="" required>
            <div class="invalid-feedback">Vui lòng nhập họ tên.</div>
          </div>

          <div class="col-12">
            <label for="customerPhone" class="form-label">Số điện thoại</label>
            <input type="tel" class="form-control" id="customerPhone" placeholder="" required>
            <div class="invalid-feedback">Vui lòng nhập số điện thoại.</div>
          </div>

          <div class="col-12">
            <label for="address" class="form-label">Địa chỉ</label>
            <input type="text" class="form-control" id="address" placeholder="123 Nguyễn Huệ, P. Bến Nghé, Q.1, TP.HCM" required>
            <div class="invalid-feedback">Vui lòng nhập địa chỉ giao hàng.</div>
          </div>
        </div>

        <hr class="my-4">

        <button class="w-100 btn btn-primary btn-lg" type="submit">Xác nhận đặt hàng</button>
      </form>
    </div>
    <div class="col-md-5">
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-primary">Giỏ hàng của bạn</span>
        <span class="badge bg-primary rounded-pill" id="item-count">0</span>
      </h4>
      <ul class="list-group mb-3" id="cart-summary-items">
        <!-- Cart summary will be loaded here -->
      </ul>
       <div class="card border-0">
         <div class="card-body">
            <li class="list-group-item d-flex justify-content-between">
              <h5 class="fw-bold">Tổng cộng (VND)</h5>
              <h5 class="fw-bold" id="total-price">0 đ</h5>
            </li>
         </div>
       </div>
    </div>
  </div>
</div>

<footer class="footer">
    <div class="container">
        <p class="text-center text-muted">&copy; 2025 CandyShop. All Rights Reserved.</p>
    </div>
</footer>

<script>
const token = localStorage.getItem('accessToken');

function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerText = message;
    container.appendChild(toast);
    setTimeout(() => { toast.classList.add('show'); }, 100);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}

function checkLogin() {
  if (!token) {
setTimeout(() => { window.location = '/login'; }, 1500);
    return false;
  }
  return true;
}

async function loadCheckoutData() {
    if (!checkLogin()) return;
    updateNavbar();

    // Fetch user and cart data in parallel
    const [userRes, cartRes] = await Promise.all([
        fetch('http://localhost:8080/api/auth/me', { headers: { 'Authorization': 'Bearer ' + token } }),
        fetch('http://localhost:8080/api/cart', { headers: { 'Authorization': 'Bearer ' + token } })
    ]);

    if (userRes.status === 401 || cartRes.status === 401) {
        showToast('Phiên đăng nhập hết hạn, vui lòng đăng nhập lại.', 'error');
        setTimeout(() => { window.location = '/login'; }, 1500);
        return;
    }

    const user = await userRes.json();
    const cart = await cartRes.json();

    // Pre-fill user info
    if (user.authenticated) {
        document.getElementById('customerName').value = user.fullName || '';
    }

    // Render cart summary
    const cartItemsContainer = document.getElementById('cart-summary-items');
    const totalPriceEl = document.getElementById('total-price');
    const itemCountEl = document.getElementById('item-count');
    cartItemsContainer.innerHTML = '';
    let totalPrice = 0;

    if (cart.cartItems && cart.cartItems.length > 0) {
        itemCountEl.innerText = cart.cartItems.length;
        cart.cartItems.forEach(item => {
            const subtotal = item.product.price * item.quantity;
            totalPrice += subtotal;
            cartItemsContainer.innerHTML += `
                <li class="list-group-item d-flex justify-content-between lh-sm">
                    <div>
                        <h6 class="my-0">${item.product.name}</h6>
                        <small class="text-muted">Số lượng: ${item.quantity}</small>
                    </div>
                    <span class="text-muted">${Number(subtotal).toLocaleString()} đ</span>
                </li>
            `;
        });
    } else {
        // If cart is empty, redirect back to cart page which will show the empty message
        window.location.href = '/cart.html';
    }

    totalPriceEl.innerText = Number(totalPrice).toLocaleString() + ' đ';
}

async function handleCheckout(event) {
    event.preventDefault();
    const form = event.target;

    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }

    const checkoutData = {
        customerName: document.getElementById('customerName').value,
        customerPhone: document.getElementById('customerPhone').value,
        address: document.getElementById('address').value
    };

    const res = await fetch('http://localhost:8080/api/orders', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(checkoutData)
    });

    if (res.ok) {
        showToast('Đặt hàng thành công! Bạn sẽ được chuyển hướng...');
        setTimeout(() => { window.location.href = '/orders.html'; }, 2000);
    } else {
        try {
            const error = await res.json();
            showToast(error.message || 'Lỗi khi đặt hàng.', 'error');
        } catch (e) {
            showToast('Lỗi không xác định khi đặt hàng.', 'error');
        }
    }
}

function logout() {
    localStorage.removeItem('accessToken');
    window.location.href = '/';
}

async function updateNavbar() {
    // This function can be copied from cart.html or centralized in a shared script
    const token = localStorage.getItem('accessToken');
    const navAuthContainer = document.getElementById('nav-auth');
    let cartItemCount = 0;
    if (token) {
        try {
            const res = await fetch('http://localhost:8080/api/cart', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.ok) {
                const cart = await res.json();
                cartItemCount = cart.cartItems.length;
            }
        } catch (e) { console.error(e); }
    }
    navAuthContainer.innerHTML = token ? `
        <a class="btn btn-outline-primary btn-sm me-2" href="/cart.html">
            Giỏ hàng <span class="badge bg-danger ms-1">${cartItemCount}</span>
        </a>
        <a class="btn btn-info btn-sm me-2" href="/orders.html">Đơn hàng</a>
        <button class="btn btn-outline-secondary btn-sm" onclick="logout()">Đăng xuất</button>
    ` : `
        <a class="btn btn-outline-primary btn-sm me-2" href="/cart.html">
            Giỏ hàng <span class="badge bg-danger ms-1">0</span>
        </a>
        <a class="btn btn-outline-secondary btn-sm" href="/login">Đăng nhập</a>
    `;
}

document.addEventListener('DOMContentLoaded', loadCheckoutData);
document.getElementById('checkout-form').addEventListener('submit', handleCheckout);

</script>
</body>
</html>
