<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quản lý sản phẩm</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div id="toast-container" class="toast-container"></div>

<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/"><img src="/images/logo.jpg" alt="Tiệm ngọt 108 Logo" style="height: 70px;"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <div id="nav-auth" class="ms-auto d-flex align-items-center">
        <!-- Auth state will be rendered here by JavaScript -->
      </div>
    </div>
  </div>
</nav>

<div class="container mt-5">
  <h2 class="mb-4">Quản lý sản phẩm</h2>

  <!-- Add Product Button -->
  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#productModal" id="addProductBtn">Thêm sản phẩm mới</button>

  <!-- Product List Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tên sản phẩm</th>
          <th>Mô tả</th>
          <th>Giá</th>
          <th>Danh mục</th>
          <th>Ảnh</th>
          <th>Số lượng tồn kho</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody id="productsTableBody">
        <!-- Product rows will be loaded here by JavaScript -->
      </tbody>
    </table>
  </div>
</div>

<!-- Product Add/Edit Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Thêm/Sửa sản phẩm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="productForm">
          <input type="hidden" id="productId">
          <div class="mb-3">
            <label for="productName" class="form-label">Tên sản phẩm</label>
            <input type="text" class="form-control" id="productName" required>
          </div>
          <div class="mb-3">
            <label for="productDescription" class="form-label">Mô tả</label>
            <textarea class="form-control" id="productDescription" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="productPrice" class="form-label">Giá</label>
            <input type="number" class="form-control" id="productPrice" step="0.01" required>
          </div>
          <div class="mb-3">
            <label for="productCategory" class="form-label">Danh mục</label>
            <select class="form-select" id="productCategory" required>
              <!-- Categories will be loaded here by JavaScript -->
            </select>
          </div>
          <div class="mb-3">
            <label for="productImageUrl" class="form-label">URL ảnh</label>
            <input type="text" class="form-control" id="productImageUrl" required>
          </div>
          <div class="mb-3">
            <label for="productStockQty" class="form-label">Số lượng tồn kho</label>
            <input type="number" class="form-control" id="productStockQty" required min="0">
          </div>
          <button type="button" class="btn btn-primary" id="saveProductBtn">Lưu sản phẩm</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE_URL = 'http://localhost:8080/api';
  const productsTableBody = document.getElementById('productsTableBody');
  const productModal = new bootstrap.Modal(document.getElementById('productModal'));
  const productForm = document.getElementById('productForm');
  const productIdInput = document.getElementById('productId');
  const productNameInput = document.getElementById('productName');
  const productDescriptionInput = document.getElementById('productDescription');
  const productPriceInput = document.getElementById('productPrice');
  const productCategorySelect = document.getElementById('productCategory');
  const productImageUrlInput = document.getElementById('productImageUrl');
  const productStockQtyInput = document.getElementById('productStockQty');
  const addProductBtn = document.getElementById('addProductBtn');
  const logoutBtn = document.getElementById('logout-btn');

  function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerText = message;

    container.appendChild(toast);

    setTimeout(() => {
      toast.classList.add('show');
    }, 100);

    setTimeout(() => {
      toast.classList.remove('show');
      toast.addEventListener('transitionend', () => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      });
    }, 3000);
  }

 
  async function checkAdminStatus() {
    console.log('checkAdminStatus called');
    const token = localStorage.getItem('accessToken');
    if (!token) {
      console.log('checkAdminStatus: No access token found, redirecting to login.');
      window.location.href = '/login';
      return false;
    }
    try {
      console.log('checkAdminStatus: Validating token...');
      const res = await fetch(`${API_BASE_URL}/auth/validate`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.status === 403) { 
        console.log('checkAdminStatus: 403 Forbidden, redirecting to home.');
        showToast('Bạn không có quyền truy cập trang này.', 'error');
        setTimeout(() => { window.location.href = '/'; }, 1500);
        return false;
      }
      if (!res.ok) {
        throw new Error('Failed to validate token');
      }
      const data = await res.json();
      console.log('checkAdminStatus: Token validation successful. isAdmin:', data.isAdmin);
      if (!data.isAdmin) {
        console.log('checkAdminStatus: User is not admin, redirecting to home.');
        showToast('Bạn không có quyền truy cập trang này.', 'error');
        setTimeout(() => { window.location.href = '/'; }, 1500);
        return false;
      }
      console.log('checkAdminStatus: User is admin.');
      return true;
    } catch (error) {
      console.error('checkAdminStatus: Error validating token:', error);
      localStorage.removeItem('accessToken');
      window.location.href = '/login';
      return false;
    }
  }

  async function updateNavbar() {
    const token = localStorage.getItem('accessToken');
    const navAuthContainer = document.getElementById('nav-auth');
    let cartItemCount = 0;
    let isAdmin = false;

    if (token) {
        isAdmin = await checkAdminStatus(); 
        try {
            const res = await fetch('http://localhost:8080/api/cart', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.ok) {
                const cart = await res.json();
                cartItemCount = cart.cartItems.length;
            }
        } catch (e) { console.error(e); }
    }

    let authHtml = '';
    if (token) {
        if (isAdmin) {
            authHtml = `
                <div class="dropdown me-2">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="adminDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Khu vực quản trị
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                        <li><a class="dropdown-item" href="/admin-products.html">Quản lý sản phẩm</a></li>
                        <li><a class="dropdown-item" href="/admin-customers.html">Quản lý khách hàng</a></li>
                        <li><a class="dropdown-item" href="/admin-orders.html">Quản lý đơn hàng</a></li>
                        <li><a class="dropdown-item" href="/admin-vouchers.html">Quản lý mã giảm giá</a></li>
                    </ul>
                </div>
                <button class="btn btn-outline-secondary btn-sm" id="logout-btn-dynamic" onclick="logout()">Đăng xuất</button>
            `;
        } else {
            authHtml = `
                <a class="btn btn-outline-primary btn-sm me-2" href="/cart.html">
                    Giỏ hàng <span class="badge bg-danger ms-1">${cartItemCount}</span>
                </a>
                <a class="btn btn-info btn-sm me-2" href="/orders.html">Đơn hàng</a>
                <button class="btn btn-outline-secondary btn-sm" id="logout-btn-dynamic" onclick="logout()">Đăng xuất</button>
            `;
        }
    } else {
        authHtml = `
            <a class="btn btn-outline-primary btn-sm me-2" href="/cart.html">
                Giỏ hàng <span class="badge bg-danger ms-1">0</span>
            </a>
            <a class="btn btn-outline-secondary btn-sm" href="/login">Đăng nhập</a>
        `;
    }
    navAuthContainer.innerHTML = authHtml;

    
    const dynamicLogoutBtn = document.getElementById('logout-btn-dynamic');
    if (dynamicLogoutBtn) {
        dynamicLogoutBtn.addEventListener('click', () => {
            localStorage.removeItem('accessToken');
            window.location.href = '/login';
        });
    }
}

  async function fetchProducts() {
    console.log('fetchProducts called');
    const token = localStorage.getItem('accessToken');
    if (!token) {
      console.log('fetchProducts: No token found, returning.');
      return;
    }

    try {
      console.log('fetchProducts: Fetching products from API...');
      const res = await fetch(`${API_BASE_URL}/admin/products`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) {
        throw new Error('Failed to fetch products');
      }
      const products = await res.json();
      console.log('fetchProducts: Products fetched successfully:', products);
      displayProducts(products);
    } catch (error) {
      console.error('fetchProducts: Error fetching products:', error);
      showToast('Lỗi khi tải sản phẩm.', 'error');
    }
  }

  async function fetchCategories() {
    try {
      const res = await fetch(`${API_BASE_URL}/categories`);
      if (!res.ok) {
        throw new Error('Failed to fetch categories');
      }
      const categories = await res.json();
      productCategorySelect.innerHTML = ''; 
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        productCategorySelect.appendChild(option);
      });
    } catch (error) {
      console.error('Error fetching categories:', error);
      showToast('Lỗi khi tải danh mục.', 'error');
    }
  }

  function displayProducts(products) {
    productsTableBody.innerHTML = '';
    products.forEach(product => {
      console.log('Product ID:', product.id, 'Image URL:', product.thumbnailUrl); 
      const row = productsTableBody.insertRow();
      row.innerHTML = `
        <td>${product.id}</td>
        <td>${product.name}</td>
        <td>${product.description ? product.description.substring(0, 50) + '...' : ''}</td>
        <td>${product.price.toLocaleString('vi-VN')} VNĐ</td>
        <td>${product.category ? product.category.name : 'N/A'}</td>
        <td><img src="${product.thumbnailUrl || 'https://via.placeholder.com/50'}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;"></td>
        <td>${product.stockQty}</td>
        <td>
          <button class="btn btn-sm btn-warning edit-btn" data-id="${product.id}">Sửa</button>
          <button class="btn btn-sm btn-danger delete-btn" data-id="${product.id}">Xóa</button>
        </td>
      `;
    });

    document.querySelectorAll('.edit-btn').forEach(button => {
      button.addEventListener('click', (e) => {
        const productId = e.target.dataset.id;
        editProduct(productId);
      });
    });

    document.querySelectorAll('.delete-btn').forEach(button => {
      button.addEventListener('click', (e) => {
        const productId = e.target.dataset.id;
        deleteProduct(productId);
      });
    });
  }

  addProductBtn.addEventListener('click', () => {
    productModalLabel.textContent = 'Thêm sản phẩm mới';
    productForm.reset();
    productIdInput.value = '';
    fetchCategories(); 
  });

  saveProductBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    const id = productIdInput.value;
    const name = productNameInput.value;
    const description = productDescriptionInput.value;
    const price = parseFloat(productPriceInput.value);
    const categoryId = productCategorySelect.value;
    const imageUrl = productImageUrlInput.value;
    const stockQty = parseInt(productStockQtyInput.value);

    const productData = {
      name,
      description,
      price,
      categoryId: parseInt(categoryId),
      imageUrl,
      stockQty
    };

    try {
      let res;
      if (id) {
        
        res = await fetch(`${API_BASE_URL}/admin/products/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(productData)
        });
      } else {
        
        res = await fetch(`${API_BASE_URL}/admin/products`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(productData)
        });
      }

      if (!res.ok) {
        throw new Error('Failed to save product');
      }

      showToast(`Sản phẩm đã được ${id ? 'cập nhật' : 'thêm'} thành công!`);
      productModal.hide();
      fetchProducts(); 
    } catch (error) {
      console.error('Error saving product:', error);
      showToast('Lỗi khi lưu sản phẩm.', 'error');
    }
  });

  async function editProduct(productId) {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
      const res = await fetch(`${API_BASE_URL}/products/${productId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) {
        throw new Error('Failed to fetch product for editing');
      }
      const product = await res.json();

      productModalLabel.textContent = 'Sửa sản phẩm';
      productIdInput.value = product.id;
      productNameInput.value = product.name;
      productDescriptionInput.value = product.description;
      productPriceInput.value = product.price;
      productImageUrlInput.value = product.thumbnailUrl;
      productStockQtyInput.value = product.stockQty;

      await fetchCategories(); 
      if (product.category) {
        productCategorySelect.value = product.category.id;
      }

      productModal.show();
    } catch (error) {
      console.error('Error editing product:', error);
      showToast('Lỗi khi tải thông tin sản phẩm để chỉnh sửa.', 'error');
    }
  }

  async function deleteProduct(productId) {
    if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm này không?')) {
      return;
    }

    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
      const res = await fetch(`${API_BASE_URL}/admin/products/${productId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) {
        throw new Error('Failed to delete product');
      }

      showToast('Sản phẩm đã được xóa thành công!');
      fetchProducts(); // Refresh product list
    } catch (error) {
      console.error('Error deleting product:', error);
      showToast('Lỗi khi xóa sản phẩm.', 'error');
    }
  }

  // Initial load
  document.addEventListener('DOMContentLoaded', async () => {
    await updateNavbar();
    const isAdmin = await checkAdminStatus();
    if (isAdmin) {
      fetchProducts();
      fetchCategories(); 
    }
  });
</script>
</body>
</html>