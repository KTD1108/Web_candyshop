<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quản lý khách hàng - CandyShop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div id="toast-container" class="toast-container"></div>

<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">CandyShop</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="index.html">Trang chủ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="cart.html">Giỏ hàng</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="orders.html">Đơn hàng của tôi</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="admin-products.html">Quản lý sản phẩm</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="admin-customers.html">Quản lý khách hàng</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" id="logout-btn">Đăng xuất</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-5">
  <h2 class="mb-4">Quản lý khách hàng</h2>

  <!-- Add Customer Button -->
  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#customerModal" id="addCustomerBtn">Thêm khách hàng mới</button>

  <!-- Customer List Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>Họ và tên</th>
          <th>Trạng thái</th>
          <th>Vai trò</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody id="customersTableBody">
        <!-- Customer rows will be loaded here by JavaScript -->
      </tbody>
    </table>
  </div>
</div>

<!-- Customer Add/Edit Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerModalLabel">Thêm/Sửa khách hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="customerForm">
          <input type="hidden" id="customerId">
          <div class="mb-3">
            <label for="customerEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="customerEmail" required>
          </div>
          <div class="mb-3">
            <label for="customerFullName" class="form-label">Họ và tên</label>
            <input type="text" class="form-control" id="customerFullName" required>
          </div>
          <div class="mb-3">
            <label for="customerEnabled" class="form-label">Trạng thái</label>
            <select class="form-select" id="customerEnabled">
              <option value="true">Hoạt động</option>
              <option value="false">Bị khóa</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="customerRoles" class="form-label">Vai trò</label>
            <div id="customerRoles" class="form-check">
              <!-- Roles will be loaded here by JavaScript -->
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Lưu khách hàng</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE_URL = 'http://localhost:8080/api';
  const customersTableBody = document.getElementById('customersTableBody');
  const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));
  const customerForm = document.getElementById('customerForm');
  const customerIdInput = document.getElementById('customerId');
  const customerEmailInput = document.getElementById('customerEmail');
  const customerFullNameInput = document.getElementById('customerFullName');
  const customerEnabledSelect = document.getElementById('customerEnabled');
  const customerRolesDiv = document.getElementById('customerRoles');
  const addCustomerBtn = document.getElementById('addCustomerBtn');
  const logoutBtn = document.getElementById('logout-btn');

  function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerText = message;

    container.appendChild(toast);

    setTimeout(() => {
      toast.classList.add('show');
    }, 100);

    setTimeout(() => {
      toast.classList.remove('show');
      toast.addEventListener('transitionend', () => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      });
    }, 3000);
  }

  async function checkAdminStatus() {
    const token = localStorage.getItem('accessToken');
    if (!token) {
      window.location.href = 'login.html';
      return false;
    }
    try {
      const res = await fetch(`${API_BASE_URL}/auth/validate`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.status === 403) {
        showToast('Bạn không có quyền truy cập trang này.', 'error');
        setTimeout(() => { window.location.href = 'index.html'; }, 1500);
        return false;
      }
      if (!res.ok) {
        throw new Error('Failed to validate token');
      }
      const data = await res.json();
      if (!data.isAdmin) {
        showToast('Bạn không có quyền truy cập trang này.', 'error');
        setTimeout(() => { window.location.href = 'index.html'; }, 1500);
        return false;
      }
      return true;
    } catch (error) {
      console.error('Error validating token:', error);
      localStorage.removeItem('accessToken');
      window.location.href = 'login.html';
      return false;
    }
  }

  async function fetchCustomers() {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
      const res = await fetch(`${API_BASE_URL}/admin/users`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) {
        throw new Error('Failed to fetch customers');
      }
      const customers = await res.json();
      displayCustomers(customers);
    } catch (error) {
      console.error('Error fetching customers:', error);
      showToast('Lỗi khi tải danh sách khách hàng.', 'error');
    }
  }

  async function fetchRoles() {
    const token = localStorage.getItem('accessToken');
    if (!token) return; // Should not happen if checkAdminStatus works

    try {
      const res = await fetch(`${API_BASE_URL}/roles`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) {
        throw new Error('Failed to fetch roles');
      }
      const roles = await res.json();
      customerRolesDiv.innerHTML = '';
      roles.forEach(role => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
          <input class="form-check-input" type="checkbox" value="${role.id}" id="role${role.id}">
          <label class="form-check-label" for="role${role.id}">${role.name}</label>
        `;
        customerRolesDiv.appendChild(div);
      });
    } catch (error) {
      console.error('Error fetching roles:', error);
      showToast('Lỗi khi tải vai trò.', 'error');
    }
  }

  function displayCustomers(customers) {
    customersTableBody.innerHTML = '';
    customers.forEach(customer => {
      const row = customersTableBody.insertRow();
      const roles = customer.roles.map(role => role.name).join(', ');
      row.innerHTML = `
        <td>${customer.id}</td>
        <td>${customer.email}</td>
        <td>${customer.fullName}</td>
        <td>${customer.enabled ? 'Hoạt động' : 'Bị khóa'}</td>
        <td>${roles}</td>
        <td>
          <button class="btn btn-sm btn-warning edit-btn" data-id="${customer.id}">Sửa</button>
          <button class="btn btn-sm btn-danger delete-btn" data-id="${customer.id}">Xóa</button>
        </td>
      `;
    });

    document.querySelectorAll('.edit-btn').forEach(button => {
      button.addEventListener('click', (e) => {
        const customerId = e.target.dataset.id;
        editCustomer(customerId);
      });
    });

    document.querySelectorAll('.delete-btn').forEach(button => {
      button.addEventListener('click', (e) => {
        const customerId = e.target.dataset.id;
        deleteCustomer(customerId);
      });
    });
  }

  addCustomerBtn.addEventListener('click', () => {
    customerModalLabel.textContent = 'Thêm khách hàng mới';
    customerForm.reset();
    customerIdInput.value = '';
    customerEmailInput.readOnly = false; // Email should be editable for new users
    fetchRoles().then(() => {
      // Uncheck all roles for new user
      customerRolesDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
    });
  });

  customerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    const id = customerIdInput.value;
    const email = customerEmailInput.value;
    const fullName = customerFullNameInput.value;
    const enabled = customerEnabledSelect.value === 'true';
    const roleIds = Array.from(customerRolesDiv.querySelectorAll('input[type="checkbox"]:checked'))
                          .map(checkbox => parseInt(checkbox.value));

    const customerData = {
      email,
      fullName,
      enabled,
      roleIds
    };

    try {
      let res;
      if (id) {
        // Update customer
        res = await fetch(`${API_BASE_URL}/admin/users/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(customerData)
        });
      } else {
        // Add new customer
        res = await fetch(`${API_BASE_URL}/admin/users`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(customerData)
        });
      }

      if (!res.ok) {
        throw new Error('Failed to save customer');
      }

      showToast(`Khách hàng đã được ${id ? 'cập nhật' : 'thêm'} thành công!`);
      customerModal.hide();
      fetchCustomers(); // Refresh customer list
    } catch (error) {
      console.error('Error saving customer:', error);
      showToast('Lỗi khi lưu khách hàng.', 'error');
    }
  });

  async function editCustomer(customerId) {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
      const res = await fetch(`${API_BASE_URL}/admin/users/${customerId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) {
        throw new Error('Failed to fetch customer for editing');
      }
      const customer = await res.json();

      customerModalLabel.textContent = 'Sửa khách hàng';
      customerIdInput.value = customer.id;
      customerEmailInput.value = customer.email;
      customerEmailInput.readOnly = true; // Email should not be editable for existing users
      customerFullNameInput.value = customer.fullName;
      customerEnabledSelect.value = customer.enabled.toString();

      await fetchRoles(); // Load roles before setting checked
      const customerRoleIds = new Set(customer.roles.map(role => role.id));
      customerRolesDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = customerRoleIds.has(parseInt(checkbox.value));
      });

      customerModal.show();
    } catch (error) {
      console.error('Error editing customer:', error);
      showToast('Lỗi khi tải thông tin khách hàng để chỉnh sửa.', 'error');
    }
  }

  async function deleteCustomer(customerId) {
    if (!confirm('Bạn có chắc chắn muốn xóa khách hàng này không?')) {
      return;
    }

    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
      const res = await fetch(`${API_BASE_URL}/admin/users/${customerId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) {
        throw new Error('Failed to delete customer');
      }

      showToast('Khách hàng đã được xóa thành công!');
      fetchCustomers(); // Refresh customer list
    } catch (error) {
      console.error('Error deleting customer:', error);
      showToast('Lỗi khi xóa khách hàng.', 'error');
    }
  }

  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('accessToken');
    window.location.href = 'login.html';
  });

  document.addEventListener('DOMContentLoaded', async () => {
    const isAdmin = await checkAdminStatus();
    if (isAdmin) {
      fetchCustomers();
    }
  });
</script>
</body>
</html>