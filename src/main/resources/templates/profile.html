<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hồ sơ của tôi - CandyShop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div id="toast-container" class="toast-container"></div>

<nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/"><img src="/images/logo.jpg" alt="CandyShop Logo" style="height: 70px;"></a>
    <div id="nav-auth" class="ms-auto d-flex align-items-center">
      <!-- Auth state will be rendered here by JavaScript -->
    </div>
  </div>
</nav>

<div class="container py-5">
  <h2 class="text-center mb-5 section-title">Hồ sơ của tôi</h2>
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <form id="profileForm">
            <div class="mb-3">
              <label for="fullName" class="form-label">Họ và tên</label>
              <input type="text" class="form-control" id="fullName" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" readonly>
            </div>
            <div class="mb-3">
              <label for="currentPassword" class="form-label">Mật khẩu hiện tại (để xác nhận thay đổi)</label>
              <input type="password" class="form-control" id="currentPassword">
            </div>
            <div class="mb-3">
              <label for="newPassword" class="form-label">Mật khẩu mới (để trống nếu không đổi)</label>
              <input type="password" class="form-control" id="newPassword">
            </div>
            <div class="mb-3">
              <label for="confirmNewPassword" class="form-label">Xác nhận mật khẩu mới</label>
              <input type="password" class="form-control" id="confirmNewPassword">
            </div>
            <button type="submit" class="btn btn-primary w-100">Cập nhật hồ sơ</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="footer">
    <div class="container">
        <p class="text-center text-muted">&copy; 2025 CandyShop. All Rights Reserved.</p>
    </div>
</footer>

<script>
const API_BASE_URL = 'http://localhost:8080/api';
const profileForm = document.getElementById('profileForm');
const fullNameInput = document.getElementById('fullName');
const emailInput = document.getElementById('email');
const currentPasswordInput = document.getElementById('currentPassword');
const newPasswordInput = document.getElementById('newPassword');
const confirmNewPasswordInput = document.getElementById('confirmNewPassword');

function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerText = message;
    container.appendChild(toast);
    setTimeout(() => { toast.classList.add('show'); }, 100);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}

async function checkLogin() {
  const token = localStorage.getItem('accessToken');
  if (!token) {
    showToast('Bạn cần đăng nhập để xem hồ sơ.', 'error');
    setTimeout(() => { window.location = '/login'; }, 1500);
    return false;
  }
  return true;
}

async function loadProfile() {
    if (!checkLogin()) return;
    updateNavbar();

    const token = localStorage.getItem('accessToken');
    try {
        const res = await fetch(`${API_BASE_URL}/auth/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.status === 401) {
            showToast('Phiên đăng nhập hết hạn, vui lòng đăng nhập lại.', 'error');
            setTimeout(() => { window.location = '/login'; }, 1500);
            return;
        }
        if (!res.ok) {
            throw new Error('Failed to fetch user profile');
        }
        const user = await res.json();
        fullNameInput.value = user.fullName;
        emailInput.value = user.email;
    } catch (error) {
        console.error('Error loading profile:', error);
        showToast('Lỗi khi tải hồ sơ người dùng.', 'error');
    }
}

profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!checkLogin()) return;

    const token = localStorage.getItem('accessToken');
    const fullName = fullNameInput.value;
    const currentPassword = currentPasswordInput.value;
    const newPassword = newPasswordInput.value;
    const confirmNewPassword = confirmNewPasswordInput.value;

    if (newPassword && newPassword !== confirmNewPassword) {
        showToast('Mật khẩu mới và xác nhận mật khẩu không khớp.', 'error');
        return;
    }

    const updateData = {
        fullName,
        currentPassword,
        newPassword: newPassword || null // Send null if not changing password
    };

    try {
        const res = await fetch(`${API_BASE_URL}/auth/me`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(updateData)
        });

        if (res.status === 401) {
            showToast('Phiên đăng nhập hết hạn, vui lòng đăng nhập lại.', 'error');
            setTimeout(() => { window.location = '/login'; }, 1500);
            return;
        }
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.message || 'Failed to update profile');
        }

        showToast('Hồ sơ đã được cập nhật thành công!');
        // Clear password fields after successful update
        currentPasswordInput.value = '';
        newPasswordInput.value = '';
        confirmNewPasswordInput.value = '';
        loadProfile(); // Reload profile to ensure data consistency
    } catch (error) {
        console.error('Error updating profile:', error);
        showToast(`Lỗi khi cập nhật hồ sơ: ${error.message}`, 'error');
    }
});

function logout() {
    localStorage.removeItem('accessToken');
    window.location.href = '/';
}

async function updateNavbar() {
    const token = localStorage.getItem('accessToken');
    const navAuthContainer = document.getElementById('nav-auth');
    let cartItemCount = 0;
    if (token) {
        try {
            const res = await fetch('http://localhost:8080/api/cart', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.ok) {
                const cart = await res.json();
                cartItemCount = cart.cartItems.length;
            }
        } catch (e) { console.error(e); }
    }
    navAuthContainer.innerHTML = token ? `
        <a class="btn btn-outline-primary btn-sm me-2" href="/cart.html">
            Giỏ hàng <span class="badge bg-danger ms-1">${cartItemCount}</span>
        </a>
        <a class="btn btn-info btn-sm me-2" href="/orders.html">Đơn hàng</a>
        <a class="btn btn-secondary btn-sm me-2 active" href="/profile.html">Hồ sơ</a>
        <a class="btn btn-info btn-sm me-2" href="/contact.html">Liên hệ</a>
        <button class="btn btn-outline-secondary btn-sm" onclick="logout()">Đăng xuất</button>
    ` : `
        <a class="btn btn-outline-primary btn-sm me-2" href="/cart.html">
            Giỏ hàng <span class="badge bg-danger ms-1">0</span>
        </a>
        <a class="btn btn-outline-info btn-sm me-2" href="/contact.html">Liên hệ</a>
        <a class="btn btn-outline-secondary btn-sm" href="/login">Đăng nhập</a>
    `;
}

document.addEventListener('DOMContentLoaded', loadProfile);
</script>
</body>
</html>